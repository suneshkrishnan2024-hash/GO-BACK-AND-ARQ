// Go-Back-N ARQ ‚Äî Cosmic Edition üåå
// Sender (Left) ‚Üí Receiver (Right)
// Frames move right, ACKs move left with glow animation
// Created by Sunesh Krishnan N & Aravind G | Guided by Dr. Swaminathan Annadurai

(function(){
  const $ = s => document.querySelector(s);
  const sleep = ms => new Promise(r=>setTimeout(r,ms));
  const log = m => {
    const d=document.createElement('div');
    d.textContent=`[${new Date().toLocaleTimeString()}] ${m}`;
    $("#events").prepend(d);
  };

  const createPkt = (type,label,x,y)=>{
    const e=document.createElement('div');
    e.className='pkt';
    e.setAttribute('type',type);
    e.textContent=label;
    e.style.left=x+'px';
    e.style.top=y+'px';
    $("#channelStage").appendChild(e);
    return e;
  };

  const animate = (el,x1,y1,x2,y2,ms)=>{
    el.classList.add('travel');
    const start=performance.now();
    return new Promise(res=>{
      function step(t){
        const k=Math.min(1,(t-start)/ms);
        const e=k<.5?2*k*k:-1+(4-2*k)*k;
        el.style.left=(x1+(x2-x1)*e)+'px';
        el.style.top=(y1+(y2-y1)*e)+'px';
        if(k<1) requestAnimationFrame(step);
        else { el.classList.remove('travel'); res(); }
      }
      requestAnimationFrame(step);
    });
  };

  function ensureLabels(){
    if($('#laneLabels')) return;
    const wrap=document.createElement('div');
    wrap.id='laneLabels';
    wrap.innerHTML='<span class="tag">Sender</span><span class="tag">Receiver</span>';
    const sim=$('#simArea');
    sim.parentNode.insertBefore(wrap,sim);
  }

  function rowGeom(row){
    const sim=$('#simArea');
    const width=sim.clientWidth||1000;
    const leftX=100;
    const rightX=Math.max(250,width-120);
    const y=100+row*80;
    return {leftX,rightX,y};
  }

  async function startSim(){
    $("#channelStage").innerHTML="";
    $("#events").innerHTML="";
    ensureLabels();

    const total=parseInt($("#numFrames").value)||8;
    const N=parseInt($("#winSize").value)||4;
    const lossP=parseInt($("#lossPercent").value)||10;
    const timeout=parseInt($("#timeout").value)||6000;
    const ackLossP=parseInt($("#ackLossPercent")?.value||"5");
    const delay=parseInt($("#ackDelayMs")?.value||"700");

    const pLoss=lossP/100;
    const pAckLoss=ackLossP/100;

    let base=0,next=0,timer=null;

    function startTimer(){
      clearTimer();
      timer=setTimeout(async()=>{
        if(base<next){
          log(`‚è≥ Timeout at base ${base} ‚Üí retransmitting ${base}..${next-1}`);
          for(let s=base;s<next;s++){ await sendFrame(s,true); }
          startTimer();
        }
      },timeout);
    }
    function clearTimer(){ if(timer){ clearTimeout(timer); timer=null; } }

    async function sendFrame(seq,rtx=false){
      const {leftX,rightX,y}=rowGeom(seq);
      const lost=Math.random()<pLoss;
      const f=createPkt(lost?'lost':'frame','F'+seq,leftX,y);
      log(`${rtx?'RTX ':'Send '}Frame ${seq}${lost?' ‚ùå (lost)':''}`);
      await animate(f,leftX,y,rightX,y,2600);
      if(lost){ f.style.opacity=.4; await sleep(300); f.remove(); return false; }
      f.remove();
      const recv=createPkt('frame','F'+seq,rightX,y); recv.style.opacity=.8;
      await sleep(400); recv.remove();
      const ackLost=Math.random()<pAckLoss;
      const ack=createPkt(ackLost?'lost':'ack','A'+seq,rightX,y);
      await sleep(delay);
      await animate(ack,rightX,y,leftX,y,2000);
      if(ackLost){ log(`ACK ${seq} lost ‚ùå`); ack.style.opacity=.4; await sleep(200); ack.remove(); return false; }
      ack.remove();
      handleAck(seq);
      return true;
    }

    function handleAck(n){
      if(n>=base){
        base=n+1;
        log(`‚úÖ ACK ${n} received ‚Äî window slides to ${base}`);
        if(base===next) clearTimer(); else startTimer();
      }
    }

    log(`‚ñ∂Ô∏è Go-Back-N started (Frames=${total}, N=${N}, Loss=${lossP}%, ACK Loss=${ackLossP}%)`);
    while(base<total){
      while(next<base+N && next<total){
        await sendFrame(next);
        next++;
        if(base===next-1) startTimer();
        await sleep(200);
      }
      await sleep(100);
    }
    clearTimer();
    log('üèÅ Simulation complete.');
  }

  $("#startBtn").onclick=startSim;
  $("#resetBtn").onclick=()=>{
    $("#channelStage").innerHTML="";
    $("#events").innerHTML="";
    log('Reset complete.');
  };
})();
